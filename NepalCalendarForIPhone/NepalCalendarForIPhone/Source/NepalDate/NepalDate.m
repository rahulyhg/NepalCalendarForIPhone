/*
 * Copyright (c) 2014 Yuichi Hirano
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

#import "NepalDate.h"

@implementation NepalDate

- (id)init
{
    if (self = [super init]) {
        [self calcNepalDate:[NSDate date] nepalTimeZone:YES];
    }
    return self;
}

- (id)initWithDate:(NSDate*)date nepalTimeZone:(BOOL)nepalTimeZone
{
    if (self = [super init]) {
        [self calcNepalDate:date nepalTimeZone:nepalTimeZone];
    }
    return self;
}

#pragma mark - Private methods

+ (NSDictionary*)nepalCalendarMap
{
    return @{
             // Year : NepalYear, nepal day for Jan 1, total days in Poush, days in Month of Jan, Feb...
             @1949 : @[ @2005, @17, @30, @29, @30, @30, @31, @31, @32, @32, @31, @30, @30, @29, @30 ],
             @1950 : @[ @2006, @18, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @1951 : @[ @2007, @17, @29, @29, @30, @31, @31, @31, @31, @32, @31, @31, @29, @30, @30 ],
             @1952 : @[ @2008, @17, @30, @29, @29, @31, @31, @31, @32, @31, @31, @31, @30, @29, @30 ],
             @1953 : @[ @2009, @18, @30, @29, @30, @30, @31, @31, @32, @32, @31, @30, @30, @29, @30 ],
             @1954 : @[ @2010, @18, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @1955 : @[ @2011, @17, @29, @29, @30, @31, @31, @31, @31, @32, @31, @31, @29, @30, @30 ],
             @1956 : @[ @2012, @17, @30, @29, @30, @30, @31, @31, @32, @31, @31, @31, @30, @29, @30 ],
             @1957 : @[ @2013, @18, @30, @29, @30, @30, @31, @31, @32, @32, @31, @30, @30, @29, @30 ],
             @1958 : @[ @2014, @18, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @1959 : @[ @2015, @17, @29, @29, @30, @31, @31, @31, @31, @32, @31, @31, @29, @30, @30 ],
             @1960 : @[ @2016, @17, @30, @29, @30, @30, @31, @31, @32, @31, @31, @31, @30, @29, @30 ],
             @1961 : @[ @2017, @18, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @29, @30 ],
             @1962 : @[ @2018, @18, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @1963 : @[ @2019, @17, @29, @30, @29, @31, @31, @31, @31, @32, @31, @31, @30, @29, @30 ],
             @1964 : @[ @2020, @17, @30, @29, @30, @30, @31, @31, @32, @31, @31, @31, @30, @29, @30 ],
             @1965 : @[ @2021, @18, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @1966 : @[ @2022, @17, @29, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @1967 : @[ @2023, @17, @29, @30, @29, @31, @31, @31, @31, @32, @31, @31, @30, @29, @30 ],
             @1968 : @[ @2024, @17, @30, @29, @30, @30, @31, @31, @32, @31, @31, @31, @30, @29, @30 ],
             @1969 : @[ @2025, @18, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @1970 : @[ @2026, @17, @29, @29, @30, @31, @30, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @1971 : @[ @2027, @17, @29, @30, @29, @31, @31, @31, @32, @31, @31, @31, @30, @29, @30 ],
             @1972 : @[ @2028, @17, @30, @29, @30, @30, @31, @31, @32, @31, @32, @30, @30, @29, @30 ],
             @1973 : @[ @2029, @18, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @1974 : @[ @2030, @17, @29, @29, @30, @31, @30, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @1975 : @[ @2031, @17, @29, @30, @29, @31, @31, @31, @32, @31, @31, @31, @30, @29, @30 ],
             @1976 : @[ @2032, @17, @30, @29, @30, @30, @31, @31, @32, @32, @31, @30, @30, @29, @30 ],
             @1977 : @[ @2033, @18, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @1978 : @[ @2034, @17, @29, @29, @30, @31, @30, @32, @31, @32, @31, @31, @29, @30, @30 ],
             @1979 : @[ @2035, @17, @30, @29, @29, @31, @31, @31, @32, @31, @31, @31, @30, @29, @30 ],
             @1980 : @[ @2036, @17, @30, @29, @30, @30, @31, @31, @32, @32, @31, @30, @30, @29, @30 ],
             @1981 : @[ @2037, @18, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @1982 : @[ @2038, @17, @29, @29, @30, @31, @31, @31, @31, @32, @31, @31, @29, @30, @30 ],
             @1983 : @[ @2039, @17, @30, @29, @30, @30, @31, @31, @32, @31, @31, @31, @30, @29, @30 ],
             @1984 : @[ @2040, @17, @30, @29, @30, @30, @31, @31, @32, @32, @31, @30, @30, @29, @30 ],
             @1985 : @[ @2041, @18, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @1986 : @[ @2042, @17, @29, @29, @30, @31, @31, @31, @31, @32, @31, @31, @29, @30, @30 ],
             @1987 : @[ @2043, @17, @30, @29, @30, @30, @31, @31, @32, @31, @31, @31, @30, @29, @30 ],
             @1988 : @[ @2044, @17, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @29, @30 ],
             @1989 : @[ @2045, @18, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @1990 : @[ @2046, @17, @29, @29, @30, @31, @31, @31, @31, @32, @31, @31, @30, @29, @30 ],
             @1991 : @[ @2047, @17, @30, @29, @30, @30, @31, @31, @32, @31, @31, @31, @30, @29, @30 ],
             @1992 : @[ @2048, @17, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @1993 : @[ @2049, @17, @29, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @1994 : @[ @2050, @17, @29, @30, @29, @31, @31, @31, @31, @32, @31, @31, @30, @29, @30 ],
             @1995 : @[ @2051, @18, @30, @29, @30, @30, @31, @31, @32, @31, @31, @31, @30, @29, @30 ],
             @1996 : @[ @2052, @17, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @1997 : @[ @2053, @17, @29, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @1998 : @[ @2054, @17, @29, @30, @29, @31, @31, @31, @32, @31, @31, @31, @30, @29, @30 ],
             @1999 : @[ @2055, @17, @30, @29, @30, @30, @31, @31, @32, @31, @32, @30, @30, @29, @30 ],
             @2000 : @[ @2056, @17, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @2001 : @[ @2057, @17, @29, @29, @30, @31, @30, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @2002 : @[ @2058, @17, @29, @30, @29, @31, @31, @31, @32, @31, @31, @31, @30, @29, @30 ],
             @2003 : @[ @2059, @17, @30, @29, @30, @30, @31, @31, @32, @32, @31, @30, @30, @29, @30 ],
             @2004 : @[ @2060, @17, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @2005 : @[ @2061, @17, @29, @29, @30, @31, @30, @32, @31, @32, @31, @31, @29, @30, @29 ],
             @2006 : @[ @2062, @17, @29, @30, @29, @31, @31, @31, @32, @31, @31, @31, @30, @29, @30 ],
             @2007 : @[ @2063, @17, @30, @29, @30, @30, @31, @31, @32, @32, @31, @30, @30, @29, @30 ],
             @2008 : @[ @2064, @17, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @2009 : @[ @2065, @17, @29, @29, @30, @31, @31, @31, @31, @32, @31, @31, @29, @30, @30 ],
             @2010 : @[ @2066, @17, @30, @29, @29, @31, @31, @31, @32, @31, @31, @31, @30, @29, @30 ],
             @2011 : @[ @2067, @17, @30, @29, @30, @30, @31, @31, @32, @32, @31, @30, @30, @29, @30 ],
             @2012 : @[ @2068, @17, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @2013 : @[ @2069, @17, @29, @29, @30, @31, @31, @31, @31, @32, @31, @31, @29, @30, @30 ],
             @2014 : @[ @2070, @17, @30, @29, @30, @30, @31, @31, @32, @31, @31, @31, @30, @29, @30 ],
             @2015 : @[ @2071, @17, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @29, @30 ],
             @2016 : @[ @2072, @17, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @2017 : @[ @2073, @17, @29, @29, @30, @31, @31, @31, @31, @32, @31, @31, @30, @29, @30 ],
             @2018 : @[ @2074, @17, @30, @29, @30, @30, @31, @31, @32, @31, @31, @31, @30, @29, @30 ],
             @2019 : @[ @2075, @17, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @2020 : @[ @2076, @17, @29, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @2021 : @[ @2077, @17, @29, @30, @29, @31, @31, @31, @31, @32, @31, @31, @30, @29, @30 ],
             @2022 : @[ @2078, @17, @30, @29, @30, @30, @31, @31, @32, @31, @31, @31, @30, @29, @30 ],
             @2023 : @[ @2079, @17, @30, @29, @30, @30, @31, @32, @31, @32, @31, @30, @30, @30, @29 ],
             @2024 : @[ @2080, @16, @29, @31, @32, @31, @32, @31, @30, @30, @30, @29, @29, @30, @30 ],
             @2025 : @[ @2081, @17, @29, @31, @31, @32, @32, @31, @30, @30, @30, @29, @30, @30, @30 ],
             @2026 : @[ @2082, @17, @29, @30, @32, @31, @32, @31, @30, @30, @30, @29, @30, @30, @30 ],
             @2027 : @[ @2083, @17, @29, @31, @31, @32, @31, @31, @30, @30, @30, @29, @30, @30, @30 ],
             @2028 : @[ @2084, @17, @29, @31, @31, @32, @31, @31, @30, @30, @30, @29, @30, @30, @30 ],
             @2029 : @[ @2085, @17, @29, @31, @32, @31, @32, @30, @31, @30, @30, @29, @30, @30, @30 ],
             @2030 : @[ @2086, @17, @29, @30, @32, @31, @32, @31, @30, @30, @30, @29, @30, @30, @30 ],
             @2031 : @[ @2087, @16, @29, @31, @31, @32, @31, @31, @31, @30, @30, @29, @30, @30, @30 ],
             @2032 : @[ @2088, @16, @29, @30, @31, @32, @32, @30, @31, @30, @30, @29, @30, @30, @30 ],
             @2033 : @[ @2089, @17, @29, @30, @32, @31, @32, @31, @30, @30, @30, @29, @30, @30, @30 ],
             @2034 : @[ @2090, @17, @29, @30, @32, @31, @32, @31, @30, @30, @30, @29, @30, @30, @30 ],
            };
}

- (void)calcNepalDate:(NSDate*)date nepalTimeZone:(BOOL)nepalTimeZone
{
    NSDictionary* nepalCalendarMap = [[self class] nepalCalendarMap];

    NSCalendar* calendar = [[NSCalendar alloc] initWithCalendarIdentifier:NSGregorianCalendar];
    if (nepalTimeZone) {
        [calendar setTimeZone:[NSTimeZone timeZoneWithName:@"Asia/Katmandu"]];
    }
    NSDateComponents *components = [calendar components:NSYearCalendarUnit | NSMonthCalendarUnit | NSDayCalendarUnit
                                               fromDate:date];
    NSInteger year = [components year];

    NSArray* nepalDateData = [nepalCalendarMap objectForKey:[NSNumber numberWithInteger:year]];
    
    _nepalYear = [[nepalDateData objectAtIndex:0] integerValue];
    // Gregorian calendar date Jan 1 always fall in Poush(9) month of Nepali Calendar.
    _nepalMonth = 9;
    //Initializing Nepali DaysInMonth with total days in the month of Poush
    NSInteger nepalDaysInMonth = [[nepalDateData objectAtIndex:2] integerValue];

    // This is sum of total days in each Nepali month starting Jan 1 in Nepali month Poush
    NSInteger nepalTempDays = [[nepalDateData objectAtIndex:2] integerValue]
                                - [[nepalDateData objectAtIndex:1] integerValue] + 1;
    
    NSInteger gregorianDayOfYear = [calendar ordinalityOfUnit:NSDayCalendarUnit inUnit:NSYearCalendarUnit forDate:date];

    for (NSInteger i = 3; gregorianDayOfYear > nepalTempDays; i++)
    {
        nepalTempDays += [[nepalDateData objectAtIndex:i] integerValue];
        nepalDaysInMonth = [[nepalDateData objectAtIndex:i] integerValue];
        ++_nepalMonth;
        
        if (_nepalMonth > 12)
        {
            _nepalMonth = 1;
            ++_nepalYear;
        }
    }

    _nepalDay = nepalDaysInMonth - (nepalTempDays - gregorianDayOfYear);
}

@end
